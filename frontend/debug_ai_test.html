<!DOCTYPE html>
<html>
<head>
    <title>Debug AI Test</title>
</head>
<body>
    <h1>Debug AI Streaming Test</h1>
    <button onclick="testSimpleEndpoint()">Test Simple Endpoint</button>
    <button onclick="testRegularEndpoint()">Test Regular Endpoint</button>
    
    <div id="results"></div>

    <script>
    const token = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJNZWxvZGVlIEdhcmNpYSIsImlkZW50aXR5IjoiTWVsb2RlZSBHYXJjaWEiLCJleHAiOjE3ODc1MTA4NTl9.2eSGyeL7hiAHZ_SVe8nwb0EmSvYzIWN5_aHSiRe688k";
    
    function log(message) {
        document.getElementById('results').innerHTML += '<p>' + JSON.stringify(message) + '</p>';
        console.log(message);
    }

    async function testSimpleEndpoint() {
        log("Testing Simple Endpoint...");
        document.getElementById('results').innerHTML = '';
        
        const payload = {
            model: "default",
            messages: [
                { role: "system", content: "You are a creative synopsis generator for stories." },
                { role: "user", content: "Create a compelling synopsis for a fantasy adventure story about a young wizard discovering their powers." }
            ],
            temperature: 0.8,
            max_tokens: 100
        };
        
        try {
            const response = await fetch('/api/proxy/llm/v1/simple/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(payload)
            });
            
            log(`Response status: ${response.status}`);
            
            if (!response.ok) {
                const errorText = await response.text();
                log(`Error: ${errorText}`);
                return;
            }
            
            const reader = response.body.getReader();
            let done = false;
            let assistantText = '';
            let chunkCount = 0;
            
            while (!done) {
                const { value, done: doneReading } = await reader.read();
                done = doneReading;
                
                if (value) {
                    const chunk = new TextDecoder().decode(value);
                    log(`Raw chunk ${chunkCount}: ${JSON.stringify(chunk)}`);
                    
                    chunk.split('\\n').forEach(line => {
                        if (line.startsWith('data: ')) {
                            const data = line.slice(6);
                            if (data === '[DONE]') return;
                            
                            try {
                                const parsed = JSON.parse(data);
                                if (parsed.choices && parsed.choices[0] && parsed.choices[0].delta && parsed.choices[0].delta.content) {
                                    const content = parsed.choices[0].delta.content;
                                    assistantText += content;
                                    log(`Content: ${JSON.stringify(content)}, Total so far: ${JSON.stringify(assistantText)}`);
                                }
                            } catch (e) {
                                log(`JSON parse error: ${e.message} for data: ${JSON.stringify(data)}`);
                            }
                        }
                    });
                    
                    chunkCount++;
                    if (chunkCount > 100) break; // Prevent infinite loops
                }
            }
            
            log(`FINAL RESULT: ${JSON.stringify(assistantText)}`);
            
        } catch (error) {
            log(`Error: ${error.message}`);
        }
    }

    async function testRegularEndpoint() {
        log("Testing Regular Endpoint...");
        document.getElementById('results').innerHTML = '';
        
        const payload = {
            model: "default",
            messages: [
                { role: "user", content: "Create a compelling synopsis for a fantasy adventure story about a young wizard discovering their powers." }
            ],
            temperature: 0.8,
            max_tokens: 100
        };
        
        try {
            const response = await fetch('/api/proxy/llm/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(payload)
            });
            
            log(`Response status: ${response.status}`);
            
            if (!response.ok) {
                const errorText = await response.text();
                log(`Error: ${errorText}`);
                return;
            }
            
            // Same processing logic as above
            // ... (identical code)
            
        } catch (error) {
            log(`Error: ${error.message}`);
        }
    }
    </script>
</body>
</html>