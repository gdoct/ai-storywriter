# Dashboard Functionality Implementation

## üìã Overview
Transform the mocked dashboard into a fully functional interface by implementing backend API endpoints that provide real user statistics, recent content, and activity data.

### Current Mocked Sections
- view recent stories
- view recent scenarios  
- number of Scenarios Created
- number of Stories generated
- number of AI Models Used
- number of Stories published
- number of Scenarios published
- Last Activity

## üéØ Feature Requirements

### Backend Endpoints to Implement
- **view recent stories**: Implement an endpoint to fetch the list of stories created by the user, order by date created desc.
- **view recent scenarios**: Implement an endpoint to fetch the list of scenarios created by the user, order by date created desc.
- **number of Scenarios Created**: Implement an endpoint to count the total number of scenarios created by the user. (simple db count)
- **number of Stories generated**: Implement an endpoint to count the total number of stories generated by the user. (simple db count)
- **number of AI Models Used**: Implement an endpoint to count the total number of unique AI models used by the user. (this is currently not stored in the db, skip this counter for now)
- **number of Stories published**: not implemented yet, leave this number alone for now
- **number of Scenarios published**: not implemented yet, leave this number alone for now
- **Last Activity**: Implement an endpoint to fetch the timestamp of the user's last activity on the platform (either last save in scenario table or in stories table).

## üîß Technical Implementation

### Required Backend Endpoints

#### 1. Dashboard Statistics Endpoint
```
GET /api/dashboard/stats
```
**Purpose**: Get aggregate statistics for the authenticated user
**Response**:
```json
{
  "scenariosCreated": 12,
  "storiesGenerated": 47,
  "storiesPublished": 0,    // placeholder for future feature
  "scenariosPublished": 0,  // placeholder for future feature
  "modelsUsed": 0,          // placeholder until AI model tracking implemented
  "lastActivity": "2025-06-12T10:30:00Z"
}
```

#### 2. Recent Scenarios Endpoint
```
GET /api/dashboard/recent-scenarios?limit=5&offset=0
```
**Purpose**: Get user's most recently created/modified scenarios with pagination
**Query Parameters**:
- `limit` (optional): Number of scenarios to return (default: 5, max: 50)
- `offset` (optional): Number of scenarios to skip (default: 0)

**Response**:
```json
{
  "scenarios": [
    {
      "id": "scenario-123",
      "title": "The Mysterious Garden",
      "created": "2025-06-10T14:20:00Z",
      "generatedStoryCount": 3,
      "lastModified": "2025-06-11T09:15:00Z"
    }
  ],
  "pagination": {
    "total": 47,
    "limit": 5,
    "offset": 0,
    "hasMore": true
  }
}
```

#### 3. Recent Stories Endpoint
```
GET /api/dashboard/recent-stories?limit=5&offset=0
```
**Purpose**: Get user's most recently generated stories with pagination
**Query Parameters**:
- `limit` (optional): Number of stories to return (default: 5, max: 50)
- `offset` (optional): Number of stories to skip (default: 0)

**Response**:
```json
{
  "stories": [
    {
      "id": 456,
      "scenarioId": "scenario-123",
      "scenarioTitle": "The Mysterious Garden",
      "created": "2025-06-11T16:45:00Z",
      "wordCount": 1247,
      "preview": "In the moonlit garden, Sarah discovered..."
    }
  ],
  "pagination": {
    "total": 152,
    "limit": 5,
    "offset": 0,
    "hasMore": true
  }
}
```

#### 4. Last Activity Endpoint
```
GET /api/dashboard/last-activity
```
**Purpose**: Get user's most recent activity timestamp
**Response**:
```json
{
  "lastActivity": "2025-06-12T10:30:00Z",
  "activityType": "story_generated",
  "description": "Generated story for 'The Mysterious Garden'"
}
```

## üóÑÔ∏è Database Queries Required

### Statistics Query
```sql
-- Count scenarios
SELECT COUNT(*) FROM scenarios WHERE user_id = ? AND is_deleted = 0;

-- Count stories
SELECT COUNT(*) FROM stories s 
JOIN scenarios sc ON s.scenario_id = sc.id 
WHERE sc.user_id = ? AND sc.is_deleted = 0;

-- Last activity
SELECT MAX(created_at) FROM (
  SELECT created_at FROM scenarios WHERE user_id = ? AND is_deleted = 0
  UNION ALL
  SELECT s.created_at FROM stories s 
  JOIN scenarios sc ON s.scenario_id = sc.id 
  WHERE sc.user_id = ? AND sc.is_deleted = 0
) activities;
```

### Recent Scenarios Query
```sql
-- Get paginated recent scenarios with story counts
SELECT s.id, s.title, s.created_at, s.jsondata,
       COUNT(st.id) as story_count,
       -- Get total count for pagination
       COUNT(*) OVER() as total_count
FROM scenarios s
LEFT JOIN stories st ON s.id = st.scenario_id
WHERE s.user_id = ? AND s.is_deleted = 0
GROUP BY s.id, s.title, s.created_at, s.jsondata
ORDER BY s.created_at DESC
LIMIT ? OFFSET ?;

-- Alternative query for just the total count (if needed separately)
SELECT COUNT(*) as total_count
FROM scenarios s
WHERE s.user_id = ? AND s.is_deleted = 0;
```

### Recent Stories Query
```sql
-- Get paginated recent stories with scenario details
SELECT st.id, st.scenario_id, st.text, st.created_at,
       s.title as scenario_title,
       LENGTH(st.text) as word_count,
       SUBSTR(st.text, 1, 100) as preview,
       -- Get total count for pagination
       COUNT(*) OVER() as total_count
FROM stories st
JOIN scenarios s ON st.scenario_id = s.id
WHERE s.user_id = ? AND s.is_deleted = 0
ORDER BY st.created_at DESC
LIMIT ? OFFSET ?;

-- Alternative query for just the total count (if needed separately)
SELECT COUNT(*) as total_count
FROM stories st
JOIN scenarios s ON st.scenario_id = s.id
WHERE s.user_id = ? AND s.is_deleted = 0;
```

## üìù Implementation Plan

### Phase 1: Backend API Implementation (2 days)

**Day 1: Core Endpoints**
1. Create new dashboard controller (`backend/controllers/dashboard_controller.py`)
2. Implement statistics aggregation endpoint
3. Implement recent scenarios endpoint
4. Add proper error handling and authentication

**Day 2: Activity Tracking & Stories**
1. Implement recent stories endpoint with scenario join
2. Implement last activity tracking
3. Add word count calculation for stories
4. Write comprehensive tests

### Phase 2: Frontend Integration (1 day)

**Day 3: Dashboard Service & Integration**
1. Create dashboard API service (`frontend/src/services/dashboardService.ts`)
2. Replace mocked data with real API calls in `Dashboard.tsx`
3. Add loading states and error handling
4. Update dashboard component to use real data

### Phase 3: Testing & Polish (0.5 days)

**Day 4: Testing & Documentation**
1. End-to-end testing of dashboard functionality
2. Performance optimization for aggregation queries
3. Update API documentation
4. Code review and refinement

## üìÅ File Structure

### New Files to Create
```
backend/controllers/dashboard_controller.py
frontend/src/services/dashboardService.ts
backend/tests/test_dashboard_controller.py
```

### Files to Modify
```
backend/app.py (register dashboard blueprint)
frontend/src/pages/Dashboard.tsx (replace mocked data)
```

## üîß Backend Controller Structure
```python
# backend/controllers/dashboard_controller.py
from flask import Blueprint, jsonify, request
from flask_jwt_extended import jwt_required, get_jwt_identity
from data.repositories import UserRepository, ScenarioRepository, GeneratedTextRepository

dashboard_bp = Blueprint('dashboard', __name__)

@dashboard_bp.route('/api/dashboard/stats', methods=['GET'])
@jwt_required()
def get_dashboard_stats():
    username = get_jwt_identity()
    user = UserRepository.get_user_by_username(username)
    # Implementation details...

@dashboard_bp.route('/api/dashboard/recent-scenarios', methods=['GET'])
@jwt_required()
def get_recent_scenarios():
    limit = request.args.get('limit', 5, type=int)
    offset = request.args.get('offset', 0, type=int)
    # Validate limits
    limit = min(max(1, limit), 50)  # Between 1 and 50
    offset = max(0, offset)
    # Implementation details...

@dashboard_bp.route('/api/dashboard/recent-stories', methods=['GET'])
@jwt_required()
def get_recent_stories():
    limit = request.args.get('limit', 5, type=int)
    offset = request.args.get('offset', 0, type=int)
    # Validate limits
    limit = min(max(1, limit), 50)  # Between 1 and 50
    offset = max(0, offset)
    # Implementation details...

@dashboard_bp.route('/api/dashboard/last-activity', methods=['GET'])
@jwt_required()
def get_last_activity():
    # Implementation details...
```

## üéØ Frontend Service Structure
```typescript
// frontend/src/services/dashboardService.ts
interface DashboardStats {
  scenariosCreated: number;
  storiesGenerated: number;
  storiesPublished: number;
  scenariosPublished: number;
  modelsUsed: number;
  lastActivity: string;
}

interface RecentScenario {
  id: string;
  title: string;
  created: string;
  generatedStoryCount: number;
}

interface RecentStory {
  id: number;
  scenarioId: string;
  scenarioTitle: string;
  created: string;
  wordCount: number;
  preview: string;
}

interface PaginatedResponse<T> {
  data: T[];
  pagination: {
    total: number;
    limit: number;
    offset: number;
    hasMore: boolean;
  };
}

interface ScenariosResponse extends PaginatedResponse<RecentScenario> {
  scenarios: RecentScenario[];
}

interface StoriesResponse extends PaginatedResponse<RecentStory> {
  stories: RecentStory[];
}

export const fetchDashboardStats = async (): Promise<DashboardStats> => {
  // Implementation details...
};

export const fetchRecentScenarios = async (limit = 5, offset = 0): Promise<ScenariosResponse> => {
  // Implementation details...
};

export const fetchRecentStories = async (limit = 5, offset = 0): Promise<StoriesResponse> => {
  // Implementation details...
};
```

## ‚úÖ Acceptance Criteria

1. **Dashboard loads with real user data** - No more mocked statistics
2. **Recent scenarios show actual user scenarios** - Ordered by creation date
3. **Recent stories show actual generated stories** - With word counts and previews
4. **Last activity reflects real user actions** - Accurate timestamp
5. **Performance is acceptable** - Dashboard loads in < 2 seconds
6. **Error handling is robust** - Graceful fallbacks for empty states
7. **Authentication is enforced** - All endpoints require valid JWT
8. **Responsive design is maintained** - No UI regressions

## üß™ Testing Strategy

### Backend Testing
- Unit tests for each endpoint
- Authentication middleware testing
- Database query performance testing
- Edge cases (empty data, large datasets)

### Frontend Testing
- Dashboard component with real API integration
- Loading states and error scenarios
- Responsive design verification
- Cross-browser compatibility

### Integration Testing
- End-to-end user flow testing
- Dashboard refresh functionality
- Real-time data updates

## üö® Potential Challenges & Solutions

1. **Performance with Large Datasets**
   - *Solution*: Implement pagination and database indexing on created_at columns
   - *Mitigation*: Add query optimization, caching, and proper LIMIT/OFFSET handling

2. **Pagination Performance**
   - *Solution*: Use window functions (COUNT(*) OVER()) to get total count efficiently
   - *Mitigation*: Consider cursor-based pagination for very large datasets

3. **Word Count Calculation**
   - *Solution*: Calculate on-the-fly using SQL LENGTH() function or store as computed field
   - *Mitigation*: Implement efficient text processing and consider caching for large texts

4. **Empty State Handling**
   - *Solution*: Maintain existing empty state UI components with proper pagination state
   - *Mitigation*: Provide helpful onboarding messages and handle zero-result pages

5. **Date Formatting Consistency**
   - *Solution*: Standardize datetime handling across frontend/backend
   - *Mitigation*: Use consistent timezone handling and ISO 8601 format

6. **Preview Text Generation**
   - *Solution*: Use SQL SUBSTR() function to generate consistent preview lengths
   - *Mitigation*: Handle edge cases like very short texts or special characters

## üîÑ Future Enhancements

1. **Real-time Updates**: WebSocket integration for live dashboard updates
2. **Advanced Analytics**: Charts and graphs for user activity trends
3. **Export Functionality**: Download user statistics and content
4. **Activity Feed**: Detailed activity timeline with filters
5. **AI Model Tracking**: Track which AI models users are using for future analytics

## üîí Security Requirements

- Ensure that the endpoints are secured and only accessible to authenticated users
- Implement proper JWT token validation
- Validate user ownership of data (scenarios and stories)
- Implement rate limiting to prevent abuse
- Sanitize all user inputs and outputs